{"version":"1012000","info":{"hostAppName":"Maya","hostAppVersion":"2014 x64"},"nodes":[{"name":"DGNode","members":[{"name":"forcePos","type":"Vec3","persistence":true,"default":"{\"x\":13,\"y\":13,\"z\":-10}"},{"name":"lightPos","type":"Vec3","persistence":true,"default":"{\"x\":-0.1958271563053131,\"y\":57.50348281860352,\"z\":67.39562225341797}"},{"name":"points","type":"Points"},{"name":"radius","type":"Scalar","persistence":true,"default":"22"},{"name":"result","type":"Vec3","persistence":true,"default":"{\"x\":0,\"y\":0,\"z\":0}"},{"name":"time","type":"Scalar","persistence":true,"default":"0"}],"dependencies":{},"bindings":[{"operator":{"name":"particleOp","entry":"particleOp","filename":"particleOp.kl","kl":"require Math;\nrequire InlineDrawing;\nrequire Points;\n\noperator simOp<<<index>>>(io Vec3 positions[], io Vec3 velocities[], Vec3 targets[], Vec3 forcePos, Scalar radius) {\n  Vec3 newVel = forcePos - positions[index];\n  if(newVel.length() < radius) {\n    velocities[index] = velocities[index].linearInterpolate(newVel * 0.5, 0.02 * mathRandomScalar(97, index * 4));\n  }\n  \n  Vec3 targetVel = targets[index] - positions[index];\n  velocities[index] = velocities[index].linearInterpolate(targetVel * 0.5, 0.001);\n  velocities[index] *= 0.9925;\n  positions[index] += velocities[index] * mathRandomScalar(93, index) * 0.2;\n}\n\noperator particleOp(in Vec3 forcePos, in Vec3 lightPos, io Points points, in Scalar radius, io Vec3 result, in Scalar time) {\n  InlineDrawing draw = OGLInlineDrawing_GetInstance();\n\n  draw.reset();\n  \n  GeometryAttributes attributes = points.getAttributes();\n  Vec3Attribute positions = attributes.getOrCreateAttribute('positions', Vec3Attribute);\n  Vec3Attribute targets = attributes.getOrCreateAttribute('targets', Vec3Attribute);\n  Vec3Attribute normals = attributes.getOrCreateAttribute('normals', Vec3Attribute);\n  Vec3Attribute velocities = attributes.getOrCreateAttribute('velocities', Vec3Attribute);\n  ColorAttribute vertexColors = attributes.getOrCreateAttribute('vertexColors', ColorAttribute);\n\n  if(time == 0 || points.size() == 0) {\n    points.resize(0);\n    points.addPoints(50000);\n    \n    Scalar dimension = 15.0;\n    for(Size i=0;i<attributes.size();i++) {\n      positions.values[i] = Vec3(\n        Math_linearInterpolate(-dimension, dimension, mathRandomScalar(17, i * 3)),\n        Math_linearInterpolate(-dimension, dimension, mathRandomScalar(10, i * 7)),\n        Math_linearInterpolate(-dimension, dimension, mathRandomScalar(19, i * 19))\n      );\n      targets.values[i] = positions.values[i];\n      normals.values[i] = positions.values[i].unit();\n      vertexColors.values[i] = Color(1.0, 0.0, 0.0).linearInterpolate(Color(1.0, 0.2, 0.0),mathRandomScalar(21, i * 17));\n    }\n    \n    positions.incrementVersion();\n    normals.incrementVersion();\n    vertexColors.incrementVersion();\n  }\n  \n  simOp<<<points.size()>>>(positions.values, velocities.values, targets.values, forcePos, radius);\n  positions.incrementVersion();\n  \n  InlineShader shader = draw.registerShader(OGLSurfaceVertexColorShader());\n  InlineMaterial mat = shader.getOrCreateMaterial('points');\n  mat.setUniform('u_ambientColor', Color(1.0, 1.0, 1.0) * 0.2);\n  mat.setUniform('u_light0Position', lightPos);\n  \n  InlineShape shape = draw.getShape('points');\n  if(shape == null)\n    shape = draw.registerShape(InlinePointsShape('points', points));\n  \n  mat.addInstance(SimpleInlineInstance('points', draw.getRoot(), shape));\n}\n","portmap":{}}}]}],"extensions":[],"ports":[{"name":"forcePos","node":"DGNode","graph":"mayaGraph","type":"Vec3","autoInitObjects":true,"member":"forcePos","mode":"in"},{"name":"lightPos","node":"DGNode","graph":"mayaGraph","type":"Vec3","autoInitObjects":true,"member":"lightPos","mode":"in"},{"name":"points","node":"DGNode","graph":"mayaGraph","type":"Points","autoInitObjects":true,"member":"points","mode":"io","options":{"action":"addIOPort","dataType":"Points","portName":"points","reference":"spliceMayaNode1"}},{"name":"radius","node":"DGNode","graph":"mayaGraph","type":"Scalar","autoInitObjects":true,"member":"radius","mode":"in"},{"name":"result","node":"DGNode","graph":"mayaGraph","type":"Vec3","autoInitObjects":true,"member":"result","mode":"out"},{"name":"time","node":"DGNode","graph":"mayaGraph","type":"Scalar","autoInitObjects":true,"member":"time","mode":"in"}]}